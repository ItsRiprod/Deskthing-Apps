
import { DeskThing } from 'deskthing-client';
import { SocketData } from 'deskthing-server';

export type WeatherData = {
    hourly: {
      time: Date[] | string[];
      temperature2m: {[key: number]: number} | Float32Array;
      relativeHumidity2m: {[key: number]: number} | Float32Array;
      dewPoint2m: {[key: number]: number} | Float32Array;
      apparentTemperature: {[key: number]: number} | Float32Array;
      precipitationProbability: {[key: number]: number} | Float32Array;
      precipitation: {[key: number]: number} | Float32Array;
      rain: {[key: number]: number} | Float32Array;
      showers: {[key: number]: number} | Float32Array;
      snowfall: {[key: number]: number} | Float32Array;
      snowDepth: {[key: number]: number} | Float32Array;
      cloudCover: {[key: number]: number} | Float32Array;
      visibility: {[key: number]: number} | Float32Array;
      windSpeed10m: {[key: number]: number} | Float32Array;
      windDirection10m: {[key: number]: number} | Float32Array;
      uvIndex: {[key: number]: number} | Float32Array;
    };
    current: {
      time: string;
      temperature2m: number;
      relativeHumidity2m: number;
      apparentTemperature: number;
      isDay: number;
      precipitation: number;
      rain: number;
      cloudCover: number;
      windSpeed10m: number;
      windDirection10m: number;
      windGusts10m: number;
    };
    daily: {
      time: string[];
      temperature2mMax: {[key: number]: number} | Float32Array;
      temperature2mMin: {[key: number]: number} | Float32Array;
      precipitationProbabilityMean: {[key: number]: number} | Float32Array;
    };
    tempUnit: string
    speedUnit: string
    longitude: string
    latitude: string
  };
type WeatherListener = (weatherData: WeatherData | null) => void;

export class WeatherStore {
  private static instance: WeatherStore | null = null;
  private weatherData: WeatherData | null = {
    "hourly": {
        "time": [
            "2024-09-08T00:00:00.000Z",
            "2024-09-08T01:00:00.000Z",
            "2024-09-08T02:00:00.000Z",
            "2024-09-08T03:00:00.000Z",
            "2024-09-08T04:00:00.000Z",
            "2024-09-08T05:00:00.000Z",
            "2024-09-08T06:00:00.000Z",
            "2024-09-08T07:00:00.000Z",
            "2024-09-08T08:00:00.000Z",
            "2024-09-08T09:00:00.000Z",
            "2024-09-08T10:00:00.000Z",
            "2024-09-08T11:00:00.000Z",
            "2024-09-08T12:00:00.000Z",
            "2024-09-08T13:00:00.000Z",
            "2024-09-08T14:00:00.000Z",
            "2024-09-08T15:00:00.000Z",
            "2024-09-08T16:00:00.000Z",
            "2024-09-08T17:00:00.000Z",
            "2024-09-08T18:00:00.000Z",
            "2024-09-08T19:00:00.000Z",
            "2024-09-08T20:00:00.000Z",
            "2024-09-08T21:00:00.000Z",
            "2024-09-08T22:00:00.000Z",
            "2024-09-08T23:00:00.000Z"
        ],
        "temperature2m": {
            "0": 105.6749038696289,
            "1": 98.38490295410156,
            "2": 96.4948959350586,
            "3": 98.83489990234375,
            "4": 94.69490051269531,
            "5": 92.80489349365234,
            "6": 91.9948959350586,
            "7": 89.65489196777344,
            "8": 88.1249008178711,
            "9": 86.95489501953125,
            "10": 87.0448989868164,
            "11": 85.96489715576172,
            "12": 84.16490173339844,
            "13": 83.80489349365234,
            "14": 86.41490173339844,
            "15": 92.98490142822266,
            "16": 96.40489196777344,
            "17": 99.55489349365234,
            "18": 102.43489837646484,
            "19": 104.41490173339844,
            "20": 105.85489654541016,
            "21": 106.57490539550781,
            "22": 106.21489715576172,
            "23": 106.03489685058594
        },
        "relativeHumidity2m": {
            "0": 17,
            "1": 30,
            "2": 25,
            "3": 18,
            "4": 19,
            "5": 25,
            "6": 21,
            "7": 22,
            "8": 23,
            "9": 23,
            "10": 23,
            "11": 26,
            "12": 26,
            "13": 25,
            "14": 24,
            "15": 20,
            "16": 18,
            "17": 16,
            "18": 13,
            "19": 11,
            "20": 10,
            "21": 9,
            "22": 13,
            "23": 12
        },
        "dewPoint2m": {
            "0": 51.943260192871094,
            "1": 61.63462829589844,
            "2": 54.942142486572266,
            "3": 47.97714614868164,
            "4": 46.05237579345703,
            "5": 51.83588409423828,
            "6": 46.48681640625,
            "7": 45.779754638671875,
            "8": 45.67893600463867,
            "9": 44.70130157470703,
            "10": 44.77652359008789,
            "11": 47.107425689697266,
            "12": 45.580379486083984,
            "13": 44.243751525878906,
            "14": 45.36909484863281,
            "15": 46.010284423828125,
            "16": 46.011592864990234,
            "17": 45.43183898925781,
            "18": 42.261863708496094,
            "19": 39.46879196166992,
            "20": 38.11916732788086,
            "21": 35.9818000793457,
            "22": 45.196685791015625,
            "23": 42.959747314453125
        },
        "apparentTemperature": {
            "0": 102.9625244140625,
            "1": 96.3537368774414,
            "2": 92.3573226928711,
            "3": 94.45335388183594,
            "4": 90.64786529541016,
            "5": 90.8965072631836,
            "6": 89.25556945800781,
            "7": 87.55887603759766,
            "8": 85.93505096435547,
            "9": 83.69253540039062,
            "10": 83.8099365234375,
            "11": 83.1303482055664,
            "12": 80.87153625488281,
            "13": 79.91343688964844,
            "14": 82.639404296875,
            "15": 86.77345275878906,
            "16": 89.51892852783203,
            "17": 93.02717590332031,
            "18": 96.85060119628906,
            "19": 99.38963317871094,
            "20": 101.30193328857422,
            "21": 101.80371856689453,
            "22": 104.60260009765625,
            "23": 102.31439208984375
        },
        "precipitationProbability": {
            "0": 0,
            "1": 1,
            "2": 2,
            "3": 3,
            "4": 4,
            "5": 5,
            "6": 6,
            "7": 5,
            "8": 4,
            "9": 3,
            "10": 3,
            "11": 3,
            "12": 3,
            "13": 3,
            "14": 3,
            "15": 3,
            "16": 2,
            "17": 1,
            "18": 0,
            "19": 0,
            "20": 0,
            "21": 0,
            "22": 0,
            "23": 0
        },
        "precipitation": {
            "0": 0,
            "1": 0,
            "2": 0,
            "3": 0,
            "4": 0,
            "5": 0,
            "6": 0,
            "7": 0,
            "8": 0,
            "9": 0,
            "10": 0,
            "11": 0,
            "12": 0,
            "13": 0,
            "14": 0,
            "15": 0,
            "16": 0,
            "17": 0,
            "18": 0,
            "19": 0,
            "20": 0,
            "21": 0,
            "22": 0,
            "23": 0
        },
        "rain": {
            "0": 0,
            "1": 0,
            "2": 0,
            "3": 0,
            "4": 0,
            "5": 0,
            "6": 0,
            "7": 0,
            "8": 0,
            "9": 0,
            "10": 0,
            "11": 0,
            "12": 0,
            "13": 0,
            "14": 0,
            "15": 0,
            "16": 0,
            "17": 0,
            "18": 0,
            "19": 0,
            "20": 0,
            "21": 0,
            "22": 0,
            "23": 0
        },
        "showers": {
            "0": 0,
            "1": 0,
            "2": 0,
            "3": 0,
            "4": 0,
            "5": 0,
            "6": 0,
            "7": 0,
            "8": 0,
            "9": 0,
            "10": 0,
            "11": 0,
            "12": 0,
            "13": 0,
            "14": 0,
            "15": 0,
            "16": 0,
            "17": 0,
            "18": 0,
            "19": 0,
            "20": 0,
            "21": 0,
            "22": 0,
            "23": 0
        },
        "snowfall": {
            "0": 0,
            "1": 0,
            "2": 0,
            "3": 0,
            "4": 0,
            "5": 0,
            "6": 0,
            "7": 0,
            "8": 0,
            "9": 0,
            "10": 0,
            "11": 0,
            "12": 0,
            "13": 0,
            "14": 0,
            "15": 0,
            "16": 0,
            "17": 0,
            "18": 0,
            "19": 0,
            "20": 0,
            "21": 0,
            "22": 0,
            "23": 0
        },
        "snowDepth": {
            "0": 0,
            "1": 0,
            "2": 0,
            "3": 0,
            "4": 0,
            "5": 0,
            "6": 0,
            "7": 0,
            "8": 0,
            "9": 0,
            "10": 0,
            "11": 0,
            "12": 0,
            "13": 0,
            "14": 0,
            "15": 0,
            "16": 0,
            "17": 0,
            "18": 0,
            "19": 0,
            "20": 0,
            "21": 0,
            "22": 0,
            "23": 0
        },
        "cloudCover": {
            "0": 18,
            "1": 66,
            "2": 31,
            "3": 2,
            "4": 31,
            "5": 100,
            "6": 100,
            "7": 100,
            "8": 100,
            "9": 100,
            "10": 100,
            "11": 59,
            "12": 10,
            "13": 52,
            "14": 52,
            "15": 12,
            "16": 67,
            "17": 100,
            "18": 100,
            "19": 95,
            "20": 95,
            "21": 78,
            "22": 0,
            "23": 0
        },
        "visibility": {
            "0": 84300,
            "1": 60200,
            "2": 70800,
            "3": 83200,
            "4": 80400,
            "5": 70400,
            "6": 76800,
            "7": 76300,
            "8": 73400,
            "9": 73300,
            "10": 73800,
            "11": 69000,
            "12": 68100,
            "13": 70300,
            "14": 72600,
            "15": 77900,
            "16": 81300,
            "17": 86400,
            "18": 90000,
            "19": 90000,
            "20": 90000,
            "21": 90000,
            "22": 90000,
            "23": 90000
        },
        "windSpeed10m": {
            "0": 7.765322208404541,
            "1": 14.3237886428833,
            "2": 13.42199993133545,
            "3": 9.064682006835938,
            "4": 7.105776786804199,
            "5": 5.816200256347656,
            "6": 4.273782253265381,
            "7": 2.335496664047241,
            "8": 2.501042127609253,
            "9": 4.479588985443115,
            "10": 4.457190990447998,
            "11": 4.885681629180908,
            "12": 5.061753273010254,
            "13": 5.716399192810059,
            "14": 6.077069282531738,
            "15": 12.207545280456543,
            "16": 13.798864364624023,
            "17": 13.818795204162598,
            "18": 12.97652816772461,
            "19": 12.577033996582031,
            "20": 11.856100082397461,
            "21": 10.86039924621582,
            "22": 6.502708911895752,
            "23": 5.871858596801758
        },
        "windDirection10m": {
            "0": 138.50363159179688,
            "1": 38.659828186035156,
            "2": 36.86997985839844,
            "3": 15.751239776611328,
            "4": 28.178495407104492,
            "5": 22.619909286499023,
            "6": 42.87890625,
            "7": 286.6993103027344,
            "8": 63.43501281738281,
            "9": 87.13765716552734,
            "10": 72.4743423461914,
            "11": 105.94546508789062,
            "12": 44.99989700317383,
            "13": 59.42085647583008,
            "14": 83.65990447998047,
            "15": 103.78162384033203,
            "16": 109.90383911132812,
            "17": 119.05451202392578,
            "18": 125.88223266601562,
            "19": 128.5006866455078,
            "20": 121.89075469970703,
            "21": 122.38066101074219,
            "22": 153.4350128173828,
            "23": 139.6355438232422
        },
        "uvIndex": {
            "0": 2.75,
            "1": 1.100000023841858,
            "2": 0.10000000149011612,
            "3": 0,
            "4": 0,
            "5": 0,
            "6": 0,
            "7": 0,
            "8": 0,
            "9": 0,
            "10": 0,
            "11": 0,
            "12": 0,
            "13": 0,
            "14": 0.20000000298023224,
            "15": 1.25,
            "16": 2.950000047683716,
            "17": 4.75,
            "18": 6.300000190734863,
            "19": 7.300000190734863,
            "20": 7.650000095367432,
            "21": 7.199999809265137,
            "22": 6.099999904632568,
            "23": 4.5
        }
    },
    "current": {
        "time": "2024-09-08T06:15:00.000Z",
        "temperature2m": 91.5448989868164,
        "relativeHumidity2m": 21,
        "apparentTemperature": 88.7123031616211,
        "isDay": 0,
        "precipitation": 0,
        "rain": 0,
        "cloudCover": 100,
        "windSpeed10m": 4.273782253265381,
        "windDirection10m": 47.12110900878906,
        "windGusts10m": 8.947999954223633
    },
    "daily": {
        "time": [
            "2024-09-08T00:00:00.000Z"
        ],
        "temperature2mMax": {
            "0": 106.57490539550781
        },
        "temperature2mMin": {
            "0": 83.80489349365234
        },
        "precipitationProbabilityMean": {
            "0": 2.25
        }
    },
    "tempUnit": "f",
    "speedUnit": "mph",
    "longitude": "-112.1235",
    "latitude": "33.5141"
}
  private deskThing: DeskThing;
  private listeners: WeatherListener[] = []

  constructor() {
    this.deskThing = DeskThing.getInstance();
    this.deskThing.on('weather_data', (data: SocketData) => {
      this.weatherData = data.payload as WeatherData;
      this.notifyListeners();
    });

    this.requestWeatherData()
  }

  static getInstance(): WeatherStore {
    if (!WeatherStore.instance) {
      WeatherStore.instance = new WeatherStore();
    }
    return WeatherStore.instance;
  }

  on(listener: WeatherListener): () => void {
    this.listeners.push(listener);
    return () => {
      this.listeners = this.listeners.filter((l) => l !== listener);
    };
  }
  getWeatherData(): WeatherData | null {
    if (!this.weatherData) {
      this.requestWeatherData()
    }
    return this.weatherData;
  }

  private notifyListeners() {
    if (!this.weatherData) {
      this.getWeatherData()
    }
    this.deskThing.sendMessageToParent({ app: 'client', type: 'log', payload: 'getting weatherData' });
    console.log('notifyListeners')
    this.listeners.forEach((listener) => listener(this.weatherData));
  }
  requestWeatherData(): void {
    this.deskThing.sendMessageToParent({ type: 'get', request: 'weather_data'});
  }



}

export default WeatherStore.getInstance();
